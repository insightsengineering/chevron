---
title: "Script Generator"
date: "2023-01-24"
author: Benoit Falquet
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Script_Generator}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(chevron)
library(dm)
library(dplyr)
```

# Introduction

In addition of the embedded `run()` method to create a `tlg`, chevron offers a script-based approach that allow the user to quickly edit a chevron workflow without the need for modifying a `chevron_tlg` object. The script is generated based on the default value of the arguments but can be edit either manually after creation or programmatically with the `dict` argument. By default, only the script corresponding to the pre processing function is detailed in the script. However, the main and post processing functions can also be exposed in the script with the `details = TRUE` argument.


# Using a chevron-defined object
The object returned by the `script` method is a vector of character with one element per line of the script, that can be easily rendered.
```{r, comment = ""}
res <- script(aet01_1)
writeLines(res)
```


# With a modified chevron object

The script generator depends on the functions actually stored in the object. Modifying the `chevron_tlg` object can lead to a different script.
```{r, comment = ""}
preprocess(aet01_1) <- function(adam_db, new_format, ...) {
  dunlin::apply_reformat(adam_db, new_format)
}

res <- script(aet01_1)
```

Print the first 20 lines of the generated script. Note that a new argument `new_format` has been added and the pre processing function has been modified.
```{r, comment = "", echo = FALSE}
writeLines(res)
```

# With custom argument definition

To programmatically define the value of an argument, pass it to a named list. Existing values will be overwritten.

Note: variables (in this case the `dm` object `syn_data`), have to be passed as symbol, using for instance `rlang::sym`.

```{r, comment = ""}
dict <- list(
  adam_db = rlang::sym("syn_data"),
  some_character = "A",
  some_vector = c("A", "B")
)

res <- script(mng01_1, dict = dict)
```

Print the first 10 lines of the generated script.
```{r, comment = "", echo = FALSE}
writeLines(res)
```

If saved in a `.R` file, the generated script can be executed. The result is stored in the `final_tlg` object, as described in the script.
```{r, fig.width=7, fig.height=7}
tmp <- tempfile("my_script", fileext = "R")
writeLines(res, con = tmp)

source(tmp, local = knitr::knit_global())
print(final_tlg[[1]])
```

# Exploring Main and Postprocess functions

By specifying `details = TRUE` the main and post processing functions are also exposed.

```{r, comment = ""}
dict <- list(
  adam_db = rlang::sym("syn_data"),
  some_character = "A",
  some_vector = c("A", "B")
)

res <- script(dmt01_1, dict = dict, details = TRUE)
```

```{r, comment = "", echo = FALSE}
writeLines(res)
```


