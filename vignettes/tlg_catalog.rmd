---
title: "Chevron Catalog"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chevron Catalog}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(dplyr)
library(dunlin)
library(chevron)
```

## **TABLES**

### **Safety Summary (`AET01`)**

#### **1. Safety Summary**

The **`aet01`** template produces the standard safety summary.

```{r}
run(aet01, syn_data, arm_var = "ARM")
```

#### **2. Safety Summary with Modified Rows**

Analyses under "Total number of patients with at least one" can be removed, added, or modified by editing the parameter `anl_vars`. The defined analyses currently include `"FATAL"`, `"SER"`, `"SERWD"`, `"SERDSM"`, `"RELSER"`, `"WD"`, `"DSM"`, `"REL"`, `"RELWD"`, `"RELDSM"`, and `"SEV"`. When modification is made, analyses must be all listed in the parameter `anl_vars`. The example below shows adding customized analyses `"RELCTC35"`.

```{r}
proc_data <- syn_data
proc_data$adae <- proc_data$adae %>%
  filter(.data$ANL01FL == "Y") %>%
  mutate(
    FATAL = with_label(.data$AESDTH == "Y", "AE with fatal outcome"),
    SER = with_label(.data$AESER == "Y", "Serious AE"),
    SEV = with_label(.data$ASEV == "SEVERE", "Severe AE (at greatest intensity)"),
    REL = with_label(.data$AREL == "Y", "Related AE"),
    WD = with_label(.data$AEACN == "DRUG WITHDRAWN", "AE leading to withdrawal from treatment"),
    DSM = with_label(
      .data$AEACN %in% c("DRUG INTERRUPTED", "DOSE INCREASED", "DOSE REDUCED"),
      "AE leading to dose modification/interruption"
    ),
    SERWD = with_label(.data$SER & .data$WD, "Serious AE leading to withdrawal from treatment"),
    SERDSM = with_label(.data$SER & .data$DSM, "Serious AE leading to dose modification/interruption"),
    RELSER = with_label(.data$SER & .data$REL, "Related Serious AE"),
    RELWD = with_label(.data$REL & .data$WD, "Related AE leading to withdrawal from treatment"),
    RELDSM = with_label(.data$REL & .data$DSM, "Related AE leading to dose modification/interruption"),
    CTC35 = with_label(.data$ATOXGR %in% c("3", "4", "5"), "Grade 3-5 AE"),
    CTC45 = with_label(.data$ATOXGR %in% c("4", "5"), "Grade 4/5 AE"),
    RELCTC35 = with_label(.data$ATOXGR %in% c("3", "4", "5") & .data$AEREL == "Y", "Related Grade 3-5")
  )

proc_data$adsl <- proc_data$adsl %>%
  mutate(DCSREAS = reformat(.data$DCSREAS, missing_rule))

run(aet01, proc_data, anl_vars = list(safety_var = c("FATAL", "SER", "RELSER", "RELCTC35")), auto_pre = FALSE)
```

### **Safety Summary (Adverse Events of Special Interest) (`AET01_AESI`)**

#### **1. Safety Summary (Adverse Events of Special Interest)**

The **`aet01_aesi`** template produces the standard safety summary for adverse events of special interest.

```{r}
run(aet01_aesi, syn_data)
```

#### **2. Safety Summary (Adverse Events of Special Interest) (optional lines)**

Additional analyses can be added with the parameter `aesi_vars`, please type `?aet01_aesi` in the console to find out the list of all pre-defined optional analyses in the help.

```{r}
run(aet01_aesi, syn_data, aesi_vars = c("RESLWD", "RELSER"))
```

#### **3. Safety Summary (Adverse Events of Special Interest) (for studies with multiple drugs)**

For studies with more than one study drug, user needs to define the analyses variable in `adae` and add to the parameter `aesi_vars` following the example above. No pre-defined analyses is available at this moment. 

### **Adverse Events (`AET02`)**

#### **1. Adverse Events**

1) The template `aet02` produces the standard adverse event summary by MedDRA system organ class and preferred term.
2) The template does not include the column of total as default. The 'All Patients' column can be added by `lbl_overall = "All Patients"`.
3) Missing values in `"AEBODSYS"`, and `"AEDECOD"` are labeled by `No Coding Available`.

```{r}
run(aet02, syn_data)
```

#### **2. Adverse Events (with High-level Term)**

The syntax below displays adverse events by MedDRA system organ class, high-level term and preferred term.

```{r}
run(aet02, syn_data, row_split_var = c("AEBODSYS", "AEHLT"))
```

#### **3. Adverse Events (Preferred Terms only)**

The syntax below displays adverse events by preferred term only.

```{r}
run(aet02, syn_data, row_split_var = NULL)
```

### **Adverse Events by Greatest Intensity(`AET03`)**

#### **1. Adverse Events by Greatest Intensity**

This **`aet03`** template  produces the standard adverse event by greatest intensity summary

```{r}
run(aet03, syn_data)
```

### **Adverse Events by Highest `NCI CTCAE` Grade (`AET04`)**

#### **1. Adverse Events by Highest `NCI CTCAE` Grade**

1) The **`aet04`** template produces the standard adverse event by highest `NCI CTCAE` grade summary.  
2) By default, this template includes the grouped grades of 'Grade 1-2' and 'Grade 3-4'.   
3) By default this template removes the rows with 0 count.   
4) If a treatment group does not have any adverse event, the treatment group is automatically displayed providing that it is defined in `ADSL`.

```{r}
run(aet04, syn_data)
```

#### **2. Adverse Events by Highest `NCI CTCAE` Grade (Fill in of Grades)**

If for some preferred terms not all grades occur but all grades should be displayed, this can be achieved by specifying `prune_0 = FALSE`.

```{r}
run(aet04, syn_data, prune_0 = FALSE)
```

#### **3. Adverse Events by Highest `NCI CTCAE` Grade with modified grouping of grade**

To collapse grade 3-4 with grade 5, this can be achieved by modifying the definition of grade groups in `grade_groups`.

```{r}
grade_groups <- list(
  "Grade 1-2" = c("1", "2"),
  "Grade 3-5" = c("3", "4", "5")
)

run(aet04, syn_data, grade_groups = grade_groups, prune_0 = FALSE)
```

### **Most Common (>=5%) Adverse Events (`AET05`)**

#### **1. Most Common (>=5%) Adverse Events**

1) The **`aet10`** template produces the standard most common adverse events occurring with relative frequency >=5% output.

```{r}
run(aet10, syn_data)
```

#### **2. Most Common (>=8%) Adverse Events (setting threshold)**

To modify the threshold for displaying preferred terms, this can be achieved by providing the threshold to the `atleast` parameter.  

```{r}
run(aet10, syn_data, atleast = 0.08)
```

### **Concomitant Medications by Medication Class and Preferred Name (`CMT01A`)**

#### **1. Concomitant Medications by Medication Class and Preferred Name**

1) The **`cmt01a`** template displays concomitant medications by `ATC Level 2` and Preferred Name by default.  
2) The template does not include the column of total by default.  
3) The template sort medication class and preferred name by alphabetical order by default.  

```{r}
run(cmt01a, syn_data)
```

#### **2. Concomitant Medications by Medication Class and Preferred Name (changing `ATC class level`)**

```{r}
run(cmt01a, syn_data, row_split_var = "ATC1")
```

#### **3. Concomitant Medications by Medication Class and Preferred Name (classes sorted by frequency)**

The option `sort_by_freq = TRUE` sort medication class by frequency.

```{r}
run(cmt01a, syn_data, sort_by_freq = TRUE)
```

#### **4. Concomitant Medications by Medication Class and Preferred Name (total number of treatments per medication class suppressed)**

The **`cmt01a`** template includes the analysis of 'total number of treatments' by default, use `incl_n_treatment = FALSE` to remove it.

```{r}
run(cmt01a, syn_data, incl_n_treatment = FALSE)
```

### **Concomitant Medications by Preferred Name (`CMT02_PT`)**

#### **1. Concomitant Medications by Preferred Name**

1) The **`cmt02_pt`** template displays concomitant medications by Preferred Name by default.  
2) The template does not include the column of total by default.  
3) The template sorts preferred name by alphabetical order by default. Set the option `sort_by_freq = TRUE` to sort preferred names by frequency.  

```{r}
run(cmt02_pt, syn_data)
```

### **Demographics and Baseline Characteristics (`DMT01`)**
  
#### **1. Demographics and Baseline Characteristics with All Patients**

1) The **`dmt01`** template produces the standard demographics and baseline characteristics summary.  
2) This template includes the column of total by default.  

```{r}
run(dmt01, syn_data)
```

#### **2. Demographics and Baseline Characteristics without All Patients**

To remove the column of total, set the parameter `lbl_overall` to `NULL`. 

```{r}
run(dmt01, syn_data, lbl_overall = NULL)
```

#### **3. Demographics and Baseline Characteristics with an additional study specific continuous variable**

1) Study specific continuous variables can be added to the standard demographics and baseline characteristics summary by editing the parameter `summaryvars`. To add or remove analyses, you need to list all variables you would like to include in the parameter.  
2) CHEVRON performs the analysis based on the type of variable as defined in the input data.    

```{r}
run(dmt01, syn_data, summaryvars = c("AGE", "AGEGR1", "SEX", "ETHNIC", "RACE", "BBMISI"), lbl_overall = NULL)
```

#### **4. Demographics and Baseline Characteristics with an additional study specific categorical variable**

1) Study specific categorical variables can be added to the standard demographics and baseline characteristics summary by editing the parameter `summaryvars`.   
2) To display the values within a categorical variable in pre-specified order, the categorical variable need to be factorized with pre-specified order provided as levels.

```{r}
proc_data <- syn_data
proc_data$adsl <- proc_data$adsl %>%
  mutate(
    SEX = reformat(.data$SEX, rule(Male = "M", Female = "F")),
    BBMIGR1 = factor(case_when(
      BBMISI < 15 ~ "Very severely underweight",
      BBMISI >= 15 & BBMISI < 16 ~ "Severely underweight",
      BBMISI >= 16 & BBMISI < 18.5 ~ "Underweight",
      BBMISI >= 18.5 & BBMISI < 25 ~ "Normal (healthy weight)",
      BBMISI >= 25 & BBMISI < 30 ~ "Overweight",
      BBMISI >= 30 & BBMISI < 35 ~ "Obese Class I (Moderately obese)",
      BBMISI >= 35 & BBMISI < 40 ~ "Obese Class II (Severely obese)",
      BBMISI >= 40 ~ "Obese Class III (Very severely obese)"
    ), levels = c(
      "Very severely underweight",
      "Severely underweight",
      "Underweight",
      "Normal (healthy weight)",
      "Overweight",
      "Obese Class I (Moderately obese)",
      "Obese Class II (Severely obese)",
      "Obese Class III (Very severely obese)"
    ))
  )

run(dmt01, proc_data, summaryvars = c("AGE", "AGEGR1", "SEX", "ETHNIC", "RACE", "BBMIGR1"), auto_pre = FALSE)
```

#### **5. Demographics and Baseline Characteristics with additional vital signs baseline values from `ADVS` or `ADSUB`**

To add baseline vital signs or other baseline characteristics to the demographics and baseline characteristics summary, manual preprocess of input `adsl` dataset is expected and merge the vital signs baseline values from `advs` (where `ADVS.ABLFL == "Y"`) or `adsub` with `adsl` by unique subject identifier.

```{r}
proc_data <- syn_data
diabpbl <- proc_data$advs %>%
  filter(ABLFL == "Y" & PARAMCD == "DIABP") %>%
  mutate(DIABPBL = AVAL) %>%
  select("STUDYID", "USUBJID", "DIABPBL")

proc_data$adsl <- proc_data$adsl %>%
  mutate(SEX = reformat(.data$SEX, rule(Male = "M", Female = "F"))) %>%
  left_join(diabpbl, by = c("STUDYID", "USUBJID"))

run(dmt01, proc_data, summaryvars = c("AGE", "AGEGR1", "SEX", "ETHNIC", "RACE", "DIABPBL"), auto_pre = FALSE)
```

### **Patient Disposition (`DST01`)**

#### **1. Patient Disposition**

1) The **`dst01`** template produces the standard patient disposition summary.  
2) The template includes the column of total by default. Use `lbl_overall = NULL` to suppress the default.   

```{r}
run(dst01, syn_data, lbl_overall = NULL)
```

#### **2. Patient Disposition (with grouping of reasons)**

1) The syntax below produces the standard patient disposition summary with grouping of the discontinuation reasons.  
2) The variable [`ADSL.DCSREASGP`] that groups the discontinuation reasons needs to be derived manually and provided in the input `adsl` dataset. 

```{r}
run(dst01, syn_data, detail_vars = list(Discontinued = c("DCSREASGP", "DCSREAS")), lbl_overall = NULL)
```

#### **3. Patient Disposition (adding end of treatment status)**

The syntax below adds the end of treatment status to the standard patient disposition summary by providing the end of treatment status variable to the parameter `trt_status_var`.

```{r}
run(dst01, syn_data, trt_status_var = "EOTSTT", lbl_overall = NULL)
```

#### **4. Patient Disposition (adding details of study ongoing status)**

The syntax adds the details of study ongoing/alive status to the standard patient disposition summary by modifying the parameter `detail_vars`.

```{r}
run(dst01, syn_data, detail_vars = list(Discontinued = "DCSREAS", Ongoing = "STDONS"))
```

### **Deaths (`DTHT01`)**

#### **1. Deaths**

The **`dtht01`** template produces the standard deaths output.

```{r}
run(dst01, syn_data)
```

#### **2. Deaths (adding "Primary Cause of Death" details for 'Other' category)**

```{r}
run(dtht01, syn_data, other_category = TRUE)
```

NOTE: In order to avoid the warning above and display 'Other' as the last category under "Primary Cause of Death" right above the detailed reasons for "Other", the user is expected to manually provide levels to `ADSL.DTHCAT` based on categories available in the dataset.

#### **3. Deaths (adding summary by days from last study drug administration)**

Setting `time_since_last_dose` to `TRUE`, the syntax produces the count of deaths by days from last study drug administration as well as the count of deaths by primary cause and days from last study drug administration.

```{r}
run(dtht01, syn_data, time_since_last_dose = TRUE)
```

### **ECG Results and Change from Baseline by Visit (`EGT01`)**

#### **1. ECG Results and Change from Baseline by Visit**

The **`egt01`** template produces the standard ECG results and change from baseline by visit summary.

```{r}
run(egt01, syn_data)
```

### **ECG Abnormalities (Regardless of Abnormality at Baseline) (`EGT02_1`)**

#### **1. ECG Abnormalities (Regardless of Abnormality at Baseline)**

The **`egt02_1`** template produces the standard ECG abnormalities summary where the abnormalities are summarized regardless of the abnormality at baseline.

```{r}
run(egt02_1, syn_data)
```

### **ECG Abnormalities (Among Subject Without Abnormality at Baseline) (`EGT02_2`)**

#### **1. ECG Abnormalities (Among Subject Without Abnormality at Baseline)**

The **`egt02_2`** template produces the standard ECG abnormalities summary where the abnormalities are summarized among subject without abnormality at baseline.

```{r}
run(egt02_2, syn_data)
```

### **Shift Table of ECG Interval Data - Baseline versus Minimum/Maximum Post-Baseline (`EGT03`)**

#### **1. Shift Table of ECG Interval Data - Baseline versus Minimum Post-Baseline**

The **`egt03`** template produces the standard shift table of ECG interval data - baseline versus minimum post-baseline summary.

```{r}
proc_data <- log_filter(syn_data, PARAMCD == "HR", "adeg")
run(egt03, proc_data)
```

#### **2. Shift Table of ECG Interval Data - Baseline versus Maximum Post-Baseline**

To produce the standard shift table of ECG interval data - baseline versus maximum post-baseline summary....TBA

### **ECG Actual Values and Changes from Baseline by Visit (`EGT05_QTCAT`)**

#### **1. ECG Actual Values and Changes from Baseline by Visit**

The **`egt05_qtcat`** template produces the standard ECG actual values and changes from baseline by visit summary.

```{r}
run(egt05_qtcat, syn_data)
```

#### **2. ECG Actual Values and Changes from Baseline by Visit (removing default analyses)**

The template have two default analyses of `ADEG.AVALCAT1` and `ADEG.CHGCAT1`. To keep only the analyses needed, this can be achieved by modifying the parameter `summaryvars`.

```{r}
run(egt05_qtcat, syn_data, summaryvars = c("AVALCAT1"))
```

### **Study Drug Exposure (`EXT01`)**

#### **1. Study Drug Exposure**

1) The **`ext01`** template displays total number of doses administered and total dose administered by default
2) The template does not include the column of total by default

```{r}
run(ext01, syn_data)
```

### **Laboratory Test Results and Change from Baseline by Visit (`LBT01`)**

#### **1. Laboratory Test Results and Change from Baseline by Visit**

1) The **`lbt01`** template produces the standard laboratory test results and change from baseline by visit.  
2) To select the SI/CV/LS results and the panel (chemistry/hematology/urinalysis/coagulation etc.) to display, user defines individual filters and apply to input datasets prior to running CHEVRON.  

```{r}
t_lb_chg <- run(lbt01, syn_data)
head(t_lb_chg, 20)
```

#### **2. Laboratory Test Results and Change from Baseline by Visit (customized precision)**
TBA

### **Laboratory Abnormalities (`LBT04`)**

#### **1. Laboratory Abnormalities**
1) The **`lbt04`** template produces the standard laboratory abnormalities summary.  
2) The template subsets to SI results by default.  
3) The laboratory tests and directions where an abnormality is possible are determined by ....?   

```{r}
run(lbt04, syn_data)
```

### **Laboratory Abnormalities with Single and Replicated Marked (`LBT05`)**

#### **1. Laboratory Abnormalities with Single and Replicated Marked**

1) The **`lbt05`** template produces the standard laboratory abnormalities summary for marked abnormalities.  
2) The laboratory tests and directions where an abnormality is possible are determined by the standard metadata for Safety Lab Standardization??

```{r}
run(lbt05, syn_data)
```

#### **2. Laboratory Abnormalities with Single and Replicated Marked showing all categories**

#### **3. Laboratory Abnormalities with Single and Replicated Marked with study specific `MLAs`**

### **Laboratory Abnormalities by Visit and Baseline Status (`LBT06`)**

#### **1. Laboratory Abnormalities by Visit and Baseline Status**

1) The **`lbt06`** template produces the standard laboratory abnormalities by visit and baseline status summary.
2) The laboratory tests and directions where an abnormality is possible are determined by....?

```{r}
run(lbt06, syn_data)
```

### **Laboratory Test Results with Highest `NCI CTCAE` Grade Post-Baseline (`LBT07`)**

#### **1. Laboratory Test Results with Highest `NCI CTCAE` Grade Post-Baseline**

The **`lbt07`** template produces the standard laboratory test results with highest `NCI CTCAE` grade post-baseline summary.

```{r}
run(lbt07, syn_data)
```

### **Laboratory Test Results Shift Table - Highest `NCI-CTCAE` Grade Post-Baseline by Baseline `NCI-CTCAE` Grade (`LBT14`)**

#### **1. Laboratory Test Results Shift Table - Highest `NCI-CTCAE` Grade Post-Baseline by Baseline `NCI-CTCAE` Grade (High)**

To produce the standard laboratory test results shift table - highest `NCI-CTCAE` grade post-baseline by baseline `NCI-CTCAE` grade summary for high abnormalities, use the **`lbt04`** template and set the parameter *`direction`* to `high`.

```{r}
run(lbt14, syn_data, direction = "high")
```

#### **2. Laboratory Test Results Shift Table - Highest `NCI-CTCAE` Grade Post-Baseline by Baseline `NCI-CTCAE` Grade (Low)**

To produce the standard laboratory test results shift table - highest `NCI-CTCAE` grade post-baseline by baseline `NCI-CTCAE` grade summary for high abnormalities, use the **`lbt04`** template and the parameter `direction` is `low` by default.

```{r}
run(lbt14, syn_data)
```

#### **3. Laboratory Test Results Shift Table - Highest `NCI-CTCAE` Grade Post-Baseline by Baseline `NCI-CTCAE` Grade (High) Without Patients with Missing Baseline**

To exclude patients with missing baseline grade, set the parameter `gr_missing` to `excl`.

```{r}
run(lbt14, syn_data, direction = "high", gr_missing = "excl")
```

#### **4. Laboratory Test Results Shift Table - Highest `NCI-CTCAE` Grade Post-Baseline by Baseline `NCI-CTCAE` Grade (Low) with Missing Baseline Considered as Grade 0**

To count patients with missing baseline grade as grade 0, set the parameter `gr_missing` to `gr_0`.

```{r}
run(lbt14, syn_data, gr_missing = "gr_0")
```

#### **4. Laboratory Test Results Shift Table - Highest `NCI-CTCAE` Grade Post-Baseline by Baseline `NCI-CTCAE` Grade (with fill in of grades)**

To display all possible grades even if they do not occur in the data, set the parameter `prune_0` to `FALSE`.

```{r}
run(lbt14, syn_data, direction = "high", prune_0 = FALSE)
```

### **Medical History (`MHT01`)**

#### **1. Medical History**

1) The **`mht01`** template displays medical conditions by MedDRA system organ class and Preferred Name by default.    
2) The default treatment variable is `ADSL.ARM`.   
3) The user is expected to use filter to subset medical conditions prior to or on entering study.  
4) By default, the template produces the overall 'total number of conditions' as well as the 'total number of conditions' per body system after the summary of patients.  
5ï¼‰This template currently does not support sorting MedDRA system organ class and preferred names by order of frequency.

```{r}
run(mht01, syn_data)
```

#### **2. Medical History showing additional column 'All Patients'**

```{r}
run(mht01, syn_data, lbl_overall = "All Patients")
```

### **Vital Signs (`VST01`)**

#### **1. Vital Sign Results and Change from Baseline by Visit**

```{r}
t_vs_chg <- run(vst01, syn_data)
head(t_vs_chg, 20)
```

### **Vital Signs Abnormalities (Regardless of Abnormality at Baseline) (`VST02_1`)**

#### **1. Vital Sign Abnormalities (Regardless of Abnormality at Baseline)**

```{r}
run(vst02_1, syn_data)
```

### **Vital Signs Abnormalities (Among Subject Without Abnormality at Baseline) (`VST02_2`)**

#### **1. Vital Sign Abnormalities (Among Subject Without Abnormality at Baseline)**

```{r}
run(vst02_2, syn_data)
```

## **LISTINGS**

### **Glossary of Adverse Event Preferred Terms and Investigator-Specified Terms (`AEL01_NOLLT`)**

#### **1. Glossary of Adverse Event Preferred Terms and Investigator-Specified Terms**

1) The **`ael01_nollt`** template produces the standard glossary of adverse event preferred terms and investigator-specified terms.
2) The example below use `head` function to print only the first 10 lines of the output.

```{r}
l_ae_nollt <- run(ael01_nollt, syn_data)
head(l_ae_nollt, 10)
```
